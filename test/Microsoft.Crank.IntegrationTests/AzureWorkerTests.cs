// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
// See the LICENSE file in the project root for more information.

using System;
using System.IO;
using System.Text;
using System.Collections.Generic;
using Microsoft.Crank.AzureDevOpsWorker;
using Xunit;
using System.Linq;

namespace Microsoft.Crank.IntegrationTests
{
    public class AzureWorkerTests
    {
        // To decode the payloads used in the unit tests:
        // Console.WriteLine(System.Text.Encoding.UTF8.GetString(Convert.FromHexString("...")));
        // To encode a json payload:
        // Console.WriteLine(Convert.ToHexString(System.Text.Encoding.UTF8.GetBytes(jsonString)));

        [Theory]
        [InlineData("4006737472696E670833687474703A2F2F736368656D61732E6D6963726F736F66742E636F6D2F323030332F31302F53657269616C697A6174696F6E2F9ADF037B0A2020226E616D65223A20226372616E6B222C0A202022636F6E646974696F6E223A2022287472756529222C0A20202261726773223A205B20222D2D7363656E6172696F2073696E676C655F7175657279202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F7363656E6172696F732F706C6174666F726D2E62656E63686D61726B732E796D6C202D2D70726F7065727479207363656E6172696F3D53696E676C655175657279506C6174666F726D50676F496E6C696E65202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F53595354454D5F4E45545F534F434B4554535F494E4C494E455F434F4D504C4554494F4E533D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F54696572656450474F3D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F54435F517569636B4A6974466F724C6F6F70733D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F5265616479546F52756E3D30202D2D6170706C69636174696F6E2E6368616E6E656C2065646765202D2D6170706C69636174696F6E2E6672616D65776F726B206E6574382E30202D2D70726F7065727479206672616D65776F726B3D6E6574382E30202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F6275696C642F63692E70726F66696C652E796D6C202D2D70726F66696C6520696E74656C2D6C696E2D617070202D2D70726F66696C6520696E74656C2D6C6F61642D6C6F6164202D2D70726F66696C6520696E74656C2D64622D646220202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F6275696C642F617A7572652E70726F66696C652E796D6C202D2D7661726961626C65206475726174696F6E3D3330202D2D6E6F2D6D65746164617461202D2D6E6F2D6D6561737572656D656E7473202D2D73657373696F6E2032303233303231362E31202D2D636F6D6D616E642D6C696E652D70726F7065727479202D2D7461626C6520426173656C696E6542656E63686D61726B73202D2D73716C2053514C5F434F4E4E454354494F4E5F535452494E47202D2D636861727422205D0A7D0A01")]
        [InlineData("4006737472696E33687474703A2F2F736368656D61732E6D6963726F736F66742E636F6D2F323030332F31302F53657269616C697A6174696F6E2FEFBFBD7B037B0A2020226E616D65223A20226372616E6B222C0A202022636F6E646974696F6E223A2022287472756529222C0A20202261726773223A205B20222D2D7363656E6172696F2073696E676C655F7175657279202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F7363656E6172696F732F706C6174666F726D2E62656E63686D61726B732E796D6C202D2D70726F7065727479207363656E6172696F3D53696E676C655175657279506C6174666F726D50676F496E6C696E65202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F53595354454D5F4E45545F534F434B4554535F494E4C494E455F434F4D504C4554494F4E533D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F54696572656450474F3D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F54435F517569636B4A6974466F724C6F6F70733D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F5265616479546F52756E3D30202D2D6170706C69636174696F6E2E6368616E6E656C2065646765202D2D6170706C69636174696F6E2E6672616D65776F726B206E6574382E30202D2D70726F7065727479206672616D65776F726B3D6E6574382E30202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F6275696C642F63692E70726F66696C652E796D6C202D2D70726F66696C6520696E74656C2D6C696E2D617070202D2D70726F66696C6520696E74656C2D6C6F61642D6C6F6164202D2D70726F66696C6520696E74656C2D64622D646220202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F6275696C642F617A7572652E70726F66696C652E796D6C202D2D7661726961626C65206475726174696F6E3D3330202D2D6E6F2D6D65746164617461202D2D6E6F2D6D6561737572656D656E7473202D2D73657373696F6E2032303233303231362E31202D2D636F6D6D616E642D6C696E652D70726F7065727479202D2D7461626C6520426173656C696E6542656E63686D61726B73202D2D73716C2053514C5F434F4E4E454354494F4E5F535452494E47202D2D636861727422205D0A7D0A01")]
        [InlineData("7B0A2020226E616D65223A20226372616E6B222C0A202022636F6E646974696F6E223A2022287472756529222C0A20202261726773223A205B20222D2D7363656E6172696F2073696E676C655F7175657279202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F7363656E6172696F732F706C6174666F726D2E62656E63686D61726B732E796D6C202D2D70726F7065727479207363656E6172696F3D53696E676C655175657279506C6174666F726D50676F496E6C696E65202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F53595354454D5F4E45545F534F434B4554535F494E4C494E455F434F4D504C4554494F4E533D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F54696572656450474F3D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F54435F517569636B4A6974466F724C6F6F70733D31202D2D6170706C69636174696F6E2E656E7669726F6E6D656E745661726961626C657320444F544E45545F5265616479546F52756E3D30202D2D6170706C69636174696F6E2E6368616E6E656C2065646765202D2D6170706C69636174696F6E2E6672616D65776F726B206E6574382E30202D2D70726F7065727479206672616D65776F726B3D6E6574382E30202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F6275696C642F63692E70726F66696C652E796D6C202D2D70726F66696C6520696E74656C2D6C696E2D617070202D2D70726F66696C6520696E74656C2D6C6F61642D6C6F6164202D2D70726F66696C6520696E74656C2D64622D646220202D2D636F6E6669672068747470733A2F2F7261772E67697468756275736572636F6E74656E742E636F6D2F6173706E65742F42656E63686D61726B732F6D61696E2F6275696C642F617A7572652E70726F66696C652E796D6C202D2D7661726961626C65206475726174696F6E3D3330202D2D6E6F2D6D65746164617461202D2D6E6F2D6D6561737572656D656E7473202D2D73657373696F6E2032303233303231362E31202D2D636F6D6D616E642D6C696E652D70726F7065727479202D2D7461626C6520426173656C696E6542656E63686D61726B73202D2D73716C2053514C5F434F4E4E454354494F4E5F535452494E47202D2D636861727422205D0A7D0A01")]
        public void ShouldParsePublishTaskPayload(string hexPayload)
        {
            #region Examples
            /* 
            @strin3http://schemas.microsoft.com/2003/10/Serialization/�{{
                "name": "...",
                "condition": "...",
                "args": [ "..." ]
            }
            
            @string3http://schemas.microsoft.com/2003/10/Serialization/��{
                "name": "...",
                "condition": "...",
                "args": [ "..." ]
            }
            
            */
            #endregion


            var bytes = Convert.FromHexString(hexPayload);

            var payload = JobPayload.Deserialize(bytes);

            Assert.Single(payload.Args);
            Assert.Equal("--scenario single_query --config https://raw.githubusercontent.com/aspnet/Benchmarks/main/scenarios/platform.benchmarks.yml --property scenario=SingleQueryPlatformPgoInline --application.environmentVariables DOTNET_SYSTEM_NET_SOCKETS_INLINE_COMPLETIONS=1 --application.environmentVariables DOTNET_TieredPGO=1 --application.environmentVariables DOTNET_TC_QuickJitForLoops=1 --application.environmentVariables DOTNET_ReadyToRun=0 --application.channel edge --application.framework net8.0 --property framework=net8.0 --config https://raw.githubusercontent.com/aspnet/Benchmarks/main/build/ci.profile.yml --profile intel-lin-app --profile intel-load-load --profile intel-db-db  --config https://raw.githubusercontent.com/aspnet/Benchmarks/main/build/azure.profile.yml --variable duration=30 --no-metadata --no-measurements --session 20230216.1 --command-line-property --table BaselineBenchmarks --sql SQL_CONNECTION_STRING --chart", payload.Args[0]);
            Assert.Equal("crank", payload.Name);
            Assert.Equal("(true)", payload.Condition);
        }

        [Theory]
        [InlineData("")]
        [InlineData("68656C6C6F")] // hello
        [InlineData("7D")] // }
        [InlineData("7B20")] // { 
        [InlineData("7B207B")] // { {
        public void ShouldNotParsePublishTaskPayload(string hexPayload)
        {
            var bytes = Convert.FromHexString(hexPayload);

            Assert.Throws<Exception>(() => JobPayload.Deserialize(bytes));
        }

        [Theory]
        [InlineData("00:20:00", "0D0A7B0D0A2020226E616D65223A20226372616E6B222C0D0A202022636F6E646974696F6E223A2022287472756529222C0D0A20202274696D656F7574223A202230303A32303A3030222C0D0A20202261726773223A205B20222D2D7363656E6172696F2073696E676C655F717565727922205D0D0A7D0D0A")]
        public void ShouldParseTimeout(string timeSpan, string hexPayload)
        {
            var bytes = Convert.FromHexString(hexPayload);

            var payload = JobPayload.Deserialize(bytes);

            Assert.Equal(timeSpan, payload.Timeout.ToString());
        }

        [Theory]
        [InlineData("7b0a2020226e616d65223a20226372616e6b222c0a202022636f6e646974696f6e223a2022287472756529222c0a20202261726773223a205b20222d2d7363656e6172696f207822205d2c0a20202266696c6573223a207b0a20202020227363656e6172696f732f62656e63686d61726b732e796d6c223a20225a6d6c735a533078222c0a20202020227363656e6172696f732f6173736574732f7061796c6f61642e6a736f6e223a202265794a72496a6f6964694a39220a20207d0a7d",
        new[] { "scenarios/benchmarks.yml", "scenarios/assets/payload.json" },
        new[] { "file-1", "{\"k\":\"v\"}" },
        2)]
        public void ShouldParseFilesFromPayload(string hexPayload, IEnumerable<string> expectedRelativePaths, IEnumerable<string> expectedContents, int fileCount)
        {
            var bytes = Convert.FromHexString(hexPayload);
            var payload = JobPayload.Deserialize(bytes);

            Assert.NotNull(payload.Files);
            Assert.Equal(fileCount, payload.Files.Count);
            for (var i = 0; i < fileCount; i++)
            {
                Assert.True(payload.Files.ContainsKey(expectedRelativePaths.ElementAt(i)));
                Assert.Equal(expectedContents.ElementAt(i), Encoding.UTF8.GetString(Convert.FromBase64String(payload.Files[expectedRelativePaths.ElementAt(i)])));
            }
        }

        [Theory]
        // Case 1: Writes files and creates directories (reuses the payload used in ShouldParseFilesFromPayload)
        [InlineData(
            "7b0a2020226e616d65223a20226372616e6b222c0a202022636f6e646974696f6e223a2022287472756529222c0a20202261726773223a205b20222d2d7363656e6172696f207822205d2c0a20202266696c6573223a207b0a20202020227363656e6172696f732f62656e63686d61726b732e796d6c223a20225a6d6c735a533078222c0a20202020227363656e6172696f732f6173736574732f7061796c6f61642e6a736f6e223a202265794a72496a6f6964694a39220a20207d0a7d",
            new[] { "scenarios/benchmarks.yml", "scenarios/assets/payload.json" },
            new[] { "file-1", "{\"k\":\"v\"}" },
            new string[] { })]
        // Case 2: Skips unsafe traversal and invalid base64, but writes safe file
        [InlineData(
            "7b226e616d65223a226372616e6b222c22636f6e646974696f6e223a22287472756529222c2261726773223a5b222d2d7363656e6172696f2078225d2c2266696c6573223a7b222e2e2f6f7574736964652e747874223a22546b395152513d3d222c22696e76616c69642e62696e223a222a2a2a6e6f742d6261736536342d2a2a2a222c22736166652e747874223a225530464752513d3d227d7d",
            new[] { "safe.txt" },
            new[] { "SAFE" },
            new[] { "invalid.bin" })]
        // Case 3: Attempts unsafe traversal (after traversing one folder in) and writes nothing
        [InlineData(
            "7B0D0A20202020226E616D65223A20226372616E6B222C0D0A2020202022636F6E646974696F6E223A22287472756529222C0D0A202020202261726773223A5B222D2D7363656E6172696F20746869735F69735F756E736166655F74726176657273616C5F66696C65225D2C0D0A202020202266696C6573223A0D0A202020207B0D0A2020202020202020222E2E2F6F7574736964652E747874223A226233563063326C6B5A53426A623235305A573530222C0D0A2020202020202020222E2E2F696E76616C69642E62696E223A222A2A2A6E6F742D6261736536342D2A2A2A222C0D0A2020202020202020226173736574732F2E2E2F2E2E2F6F757473696465322E747874223A226233563063326C6B5A544967593239756447567564413D3D220D0A202020207D7D",
            new string[] { },
            new string[] { },
            new[] { "../invalid.bin", "../outside.txt", "assets/../../outside2.txt" })]
        public void MaterializeFiles_FromPayload_WritesAndSkipsAsExpected(
            string hexPayload,
            IEnumerable<string> expectedExistingRelativePaths,
            IEnumerable<string> expectedExistingContents,
            IEnumerable<string> expectedNonExistingRelativePaths)
        {
            var bytes = Convert.FromHexString(hexPayload);
            var payload = JobPayload.Deserialize(bytes);

            var tmp = Path.Combine(Path.GetTempPath(), "crank-test-" + Guid.NewGuid().ToString("N"));
            Directory.CreateDirectory(tmp);

            var outsidePath = Path.GetFullPath(Path.Combine(tmp, "..", "outside.txt"));
            if (File.Exists(outsidePath)) File.Delete(outsidePath);

            try
            {
                Program.MaterializeFiles(payload, tmp);

                // Validate created files and contents
                var numFilesChecked = 0;
                Assert.Equal(expectedExistingRelativePaths.Count(), expectedExistingContents.Count());
                for (var i = 0; i < expectedExistingRelativePaths.Count(); i++)
                {
                    var rel = expectedExistingRelativePaths.ElementAt(i);
                    var expectedContent = expectedExistingContents.ElementAt(i);
                    var full = Path.Combine(new[] { tmp }.Concat(rel.Split('/', '\\')).ToArray());
                    Assert.True(File.Exists(full));
                    Assert.Equal(expectedContent, File.ReadAllText(full));
                    numFilesChecked++;
                }

                // Validate files that should not exist inside tmp
                foreach (var rel in expectedNonExistingRelativePaths ?? Array.Empty<string>())
                {
                    var full = Path.Combine(new[] { tmp }.Concat(rel.Split('/', '\\')).ToArray());
                    Assert.False(File.Exists(full));
                    numFilesChecked++;
                }
                // Validate that we checked the expected number of files
                Assert.Equal(expectedExistingRelativePaths.Count() + expectedNonExistingRelativePaths.Count(), numFilesChecked);

                // If the payload contains traversal attempts, ensure outside path wasn't created
                var hasTraversal = payload?.Files?.Keys?.Any(k => k.Contains("../") || k.Contains("..\\")) == true;
                if (hasTraversal)
                {
                    Assert.False(File.Exists(outsidePath));
                }
            }
            finally
            {
                TryDelete(tmp);
            }
        }

        private static void TryDelete(string dir)
        {
            try
            {
                if (!string.IsNullOrEmpty(dir) && Directory.Exists(dir))
                {
                    Directory.Delete(dir, true);
                }
            }
            catch
            {
                // best effort cleanup
            }
        }
    }
}
